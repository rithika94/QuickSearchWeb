
@model QuickSearchWeb.Models.ExpenseViewModel

@{
    ViewBag.Title = "Expense Sheet";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Scripts{
    <script>


        function rejectComment() {
            //debugger;
            var comments = document.getElementById("comments");
            if (comments.value == "") {
                document.getElementById("error").innerHTML = "Comments are required";
                $("#btnApprove").prop('disabled', false);
                $("#btnReject").prop('disabled', false);
                //comments.setCustomValidity("Please Enter Comments");
            } else {
                document.getElementById("error").innerHTML = "";
                // comments.setCustomValidity(""); // be sure to leave this empty!
                //alert("Correct!");

                $("#reject").modal("hide");
                $('.modal-backdrop').remove();
                $(".loader").show();
                var formdata = $("#rejectForm").serialize();
                //debugger;
                $.ajax({
                    type: "POST",
                    url: "/Expense/Reject",
                    data: formdata,
                    success: function () {
                        debugger;

                        //debugger;
                        $(".loader").hide();
                        window.location.href = "/Expense/EmployeeRepoManExpensesList";
                        //debugger;

                    }



                })

            }
        }

    function downloadImage(name, expenseId) {
        debugger;
        $.ajax({
            url: "@Url.Action("FileExists", "Expense")",
            data: { "imgname": name, "expenseId": expenseId },
        DataType: 'json',
        type: "POST",
        success: function (result) {
            debugger;
            if (result.isFileExists == true) {
                window.location = '/Expense/GetImage?imgname=' + name + '&expenseId=' + expenseId;
            } else {
                alert('File does not exists');
            }

        },

    });
        }


        function ApproveButton() {
            debugger;
            $("#btnApprove").prop('disabled', true);
            $("#btnReject").prop('disabled', true);

        }

        function RejectButton() {
            debugger;
            $("#btnApprove").prop('disabled', true);
            $("#btnReject").prop('disabled', true);

        }

      

      
    </script>
}

<div class="content-wrap">
    <div class="main">
        <div class="container-fluid">


            <div class="row">
                <div class="page-header">
                    <div class="page-title">
                        <div class="col-lg-4">


                            @{
                                if (ViewBag.TSRole == "TimeSheetAdmin")
                                {

                                    <input type="button" value="Back to Expense Sheets" class="btn btn-flat btn-default m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeAdminExpensesList", "Expense")'" />


                                }
                                else if (ViewBag.TSRole == "TimeSheetReportingManager")
                                {
                                    <input type="button" value="Back to Expense Sheets" class="btn btn-flat btn-default m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeRepoManExpensesList", "Expense")'" />

                                }
                                else if (ViewBag.TSRole == "TimeSheetManager")
                                {
                                    <input type="button" value="Back to Expense Sheets" class="btn btn-flat btn-default m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeManagerExpensesList", "Expense")'" />

                                }
                                else
                                {
                                    <input type="button" value="Back to Expense Sheets" class="btn btn-flat btn-default m-l-5" form="post" onclick="location.href='@Url.Action("MyExpenseList", "Expense")'" />

                                }

                            }
                        </div>
                        <div class="col-lg-4">
                            <h4 class="text-center"><strong>Expense Sheet Details</strong></h4>
                        </div>
                        <div class="col-lg-4">
                            <ol class="breadcrumb text-right">
                                <li>

                                    <a @*onclick="location.href='@Url.Action("MyExpenseList", "Expense")'"*@>Employee Expense Sheets</a>
                                </li>
                                <li class="active">Expense Sheet Details</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div><!-- /# row -->
            <div class="main-content">


                @if (ViewBag.error != null)
                {
                    <div class="alert alert-danger">
                        @ViewBag.error
                    </div>

                }

                @if (ViewBag.status != null)
                {
                    <div class="alert alert-success">
                        @ViewBag.status
                    </div>

                }

                <div class="row">
                    @Html.ValidationMessage("error", "", new { @class = "text-danger" })



                    <div class="container-fluid">
                        <div class="main-content">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="card alert">

                                        <div class="card-body">


                                            <div class="row">

                                                <div class="row">

                                                    @Html.HiddenFor(m => m.UserId)
                                                    @Html.HiddenFor(m => m.ExpenseId)
                                                    <div class="col-md-2">
                                                        @Html.LabelFor(m => m.ExpenseCode)
                                                        @Html.TextBoxFor(m => m.ExpenseCode, new { @class = "form-control", @readonly = "true" })

                                                    </div>

                                                    @Html.HiddenFor(m => m.AspNetUser.Firstname)

                                                    @Html.HiddenFor(m => m.AspNetUser.LastName)


                                                    <div class="col-md-2">
                                                        @Html.LabelFor(m => m.AspNetUser.EmployeeCode)
                                                        @Html.TextBoxFor(m => m.AspNetUser.EmployeeCode, new { @class = "form-control", @readonly = "true" })

                                                    </div>


                                                    <div class=" col-md-3">
                                                        <label>Employee Name</label>

                                                        <input class="form-control"
                                                               id="FullName"
                                                               readonly="readonly"
                                                               type="text"
                                                               value="@Model.AspNetUser.Firstname @Model.AspNetUser.LastName" />

                                                    </div>
                                                    <div class="col-md-3">
                                                        @Html.LabelFor(m => m.ReportingManager)
                                                        @Html.TextBoxFor(m => m.ReportingManager, new { @class = "form-control", @readonly = "true" })

                                                    </div>
                                                    <div class="col-md-2">
                                                        @Html.LabelFor(m => m.LookupCodeMaster)
                                                        @Html.TextBoxFor(m => m.LookupCodeMaster.LookupCodeName, new { @class = "form-control", @readonly = "true" })

                                                    </div>
                                                    <div class="col-md-3">
                                                        @Html.LabelFor(m => m.StartDate)
                                                        <div class="input-group date">
                                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span> </span>
                                                            @Html.TextBoxFor(m => m.StartDate, "{0:MM/dd/yyyy}", new { @class = "form-control", @id = "StartDate", @readonly = "true" })
                                                        </div>

                                                        @Html.ValidationMessageFor(m => m.StartDate, "", new { @class = "text-danger" })
                                                    </div>


                                                    <div class="col-md-3">
                                                        @Html.LabelFor(m => m.EndDate)
                                                        <div class="input-group date">
                                                            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span> </span>
                                                            @Html.TextBoxFor(m => m.EndDate, "{0:MM/dd/yyyy}", new { @class = "form-control", @id = "EndDate", @readonly = "true" })
                                                        </div>

                                                        @Html.ValidationMessageFor(m => m.EndDate, "", new { @class = "text-danger" })
                                                    </div>
                                                    <div class="col-md-3">
                                                        @Html.LabelFor(m => m.ApprovedBy)
                                                        @Html.TextBoxFor(m => m.ApprovedBy, new { @class = "form-control", @readonly = "true", @id = "Advance" })
                                                    </div>
                                                    @*<div class="col-md-3">
                                                            @Html.LabelFor(m => m.Advance)
                                                            @Html.TextBoxFor(m => m.Advance, new { @class = "form-control", @readonly = "true", @id = "Advance" })
                                                        </div>
                                                        <div class="col-md-3">
                                                            @Html.LabelFor(m => m.Total)
                                                            @Html.TextBoxFor(m => m.Total, new { @class = "form-control", @readonly = "true", @id = "ExpenseTotal" })
                                                        </div>*@
                                                </div>
                                                <br />

                                                <div class="panel panel-default">
                                                    <div class="panel-heading">
                                                        Add New Expense  <mark>
                                                            (Note:  For every mile of business travel driven will be calculated as per standard mileage rate for 2018 round to .55 cents.)
                                                        </mark>
                                                    </div>
                                                    <div class="panel-body">
                                                        <div class="row">
                                                            <div class="table-responsive2">
                                                                <table class="table table-striped table-bordered"  style="min-width:1080px">

                                                                    <thead>
                                                                        <tr>
                                                                            <th>Date</th>
                                                                            <th>Description</th>
                                                                            <th colspan="3">Miles Driven</th>
                                                                            <th>Transport ($)</th>
                                                                            <th>Lodging ($)</th>
                                                                            <th>Meals ($)</th>
                                                                            <th>Phone/Fax ($)</th>
                                                                            <th>Other ($)</th>
                                                                            <th>Total ($)</th>

                                                                        </tr>
                                                                        <tr>
                                                                            <th colspan="2"></th>
                                                                            <th>Miles (Mi)</th>
                                                                            <th>Standard Rate ($/Mi)</th>
                                                                            <th>Total ($)</th>
                                                                            <th colspan="6"></th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>

                                                                        @foreach (var item in Model.ExpensesSummaryList)
                                                                        {
                                                                            <tr>
                                                                                @Html.HiddenFor(m => item.Id)
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Date, new { @class = "form-control" })

                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Description, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>

                                                                                    @Html.DisplayFor(m => item.Miles, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>

                                                                                    @Html.DisplayFor(m => item.MilesMultiplicationFactor, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>

                                                                                    @Html.DisplayFor(m => item.MilesDriven, new { @class = "form-control" })
                                                                                </td>

                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Transport, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Lodging, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Meals, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Phone, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Other, new { @class = "form-control" })
                                                                                </td>
                                                                                <td>
                                                                                    @Html.DisplayFor(m => item.Total, new { @class = "form-control" })
                                                                                </td>


                                                                            </tr>
                                                                        }



                                                                        <tr>
                                                                            <td colspan="9"></td>
                                                                            <td>SubTotal</td>
                                                                            <td>
                                                                                <div class="inner-addon left-addon">
                                                                                    <i class="ti-money dollar"></i>
                                                                                    @Html.TextBoxFor(m => m.SubTotal, new { @class = "form-control", @readonly = "true", @id = "SubTotal" })
                                                                                    </div>
                                                                            </td>

                                                                        </tr>
                                                                        <tr>
                                                                            <td colspan="9"></td>
                                                                            <td>Advance</td>
                                                                            <td>
                                                                                <div class="inner-addon left-addon">
                                                                                    <i class="ti-money dollar"></i>
                                                                                    @Html.TextBoxFor(m => m.Advance, new { @class = "form-control", @readonly = "true", @id = "Advance" })
                                                                                </div>
                                                                            </td>

                                                                        </tr>
                                                                        <tr>
                                                                            <td colspan="9"></td>
                                                                            <td>Total</td>
                                                                            <td>
                                                                                <div class="inner-addon left-addon">
                                                                                    <i class="ti-money dollar"></i>
                                                                                    @Html.TextBoxFor(m => m.Total, new { @class = "form-control", @readonly = "true", @id = "ExpenseTotal" })
                                                                                </div>
                                                                            </td>

                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>


                                            @*@{Html.RenderAction("GetExpensesSummariesForDetails", new { expenseId = Model.ExpenseId });}*@
                                            @if (Model.ExpenseFilesList != null && Model.ExpenseFilesList.Count > 0)
                                            {
                                                <div class="panel panel-default">
                                                    <div class="panel-heading"> Expense receipts</div>
                                                    <div class="panel-body">

                                                        <div class="row">
                                                            <div class="bootstrap-data-table-panel">
                                                                @if (Model.ExpenseFilesList != null && Model.ExpenseFilesList.Count > 0)
                                                                {
                                                                    string FileName = string.Empty;
                                                                    <table id="datatable-buttons" class="table table-striped table-bordered">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Document Name</th>
                                                                                <th>Action</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            @foreach (var item in Model.ExpenseFilesList)
                                                                            {
                                                                                <tr>
                                                                                    <td>@item.FileName</td>


                                                                                    <td>

                                                                                        @*@using (Html.BeginForm("GetImage", "Expense", FormMethod.Get, new { @class = "form-horizontal form-label-left" }))
                                                                                            {*@

                                                                                        @*<input type="hidden" name="imgname" value="@item.FileName" />
                                                                                            <input type="hidden" name="expenseId" value="@item.ExpenseId" />*@
                                                                                        <button type="button" class="pull-left btn-warning btn-flat m-l-5" href="javascript:void(0)" onclick="downloadImage('@item.FileName','@item.ExpenseId');"> <i class="ti-download"></i></button>

                                                                                        @*<button type="submit" class="pull-right btn-warning btn-flat "><i class="ti-download"></i></button>*@
                                                                                        @*}*@


                                                                                    </td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                }
                                                            </div>
                                                        </div>


                                                    </div>
                                                </div>
                                            }
                                            <div class="row">
                                                <div class="form-group col-md-12">

                                                    @if (ViewBag.TSRole == "TimeSheetReportingManager" && Model.LookupCodeMaster.LookupCodeName != "Approved" && Model.LookupCodeMaster.LookupCodeName != "Rejected")
                                                    {

                                                        <button type="button" value="Reject" class=" btn btn-flat btn-warning m-b-10 m-l-5" data-toggle="modal" data-target="#reject" id="Save"> Reject</button>

                                                        <button type="button" value="Approve" class=" btn btn-flat btn-success m-b-10 m-l-5" data-toggle="modal" data-target="#approve" id="Save">Approve </button>
                                                    }

                                                    @{
                                                        if (ViewBag.TSRole == "TimeSheetAdmin")
                                                        {
                                                            <button type="button" value="Download" class="btn btn-flat btn-default m-b-10 m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeAdminExpenseDownload", "Expense", new { id = Model.ExpenseId})'">Download </button>

                                                        }
                                                        else if (ViewBag.TSRole == "TimeSheetReportingManager")
                                                        {
                                                            <button type="button" value="Download" class="btn btn-flat btn-default m-b-10 m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeRepoManExpenseDownload", "Expense", new { id = Model.ExpenseId})'">Download </button>

                                                        }
                                                        else if (ViewBag.TSRole == "TimeSheetManager")
                                                        {
                                                            <button type="button" value="Download" class="btn btn-flat btn-default m-b-10 m-l-5" form="post" onclick="location.href='@Url.Action("EmployeeManagerExpenseDownload", "Expense", new { id = Model.ExpenseId})'">Download </button>

                                                        }
                                                    }

                                                    @*@if (ViewBag.TSRole == "TimeSheetAdmin")
                                                    {

                                                        <button type="button" value="Delete" class="btn btn-flat btn-danger m-b-10 m-l-5" data-toggle="modal" data-target="#deleteTS" id="delete">Delete</button>

                                                    }*@


                                                </div>
                                                <div class="form-group col-md-12" style="border: 1px solid; padding:10px">
                                                    @Html.LabelFor(m => m.Comments)
                                                    <br />
                                                    <span>@Html.Raw(Model.Comments)</span>


                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div><!-- /# column -->
                            </div>


                            <div class="modal fade" id="approve" tabindex="-1" role="dialog" aria-labelledby="approve" aria-hidden="true">
                                <div class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="close"><span class="fa fa-close" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading">Approve Expense Sheet</h4>
                                        </div>
                                        <div class="modal-body">

                                            @*<div class="alert alert-warning">*@
                                            <span class="fa fa-exclamation-triangle"></span> Are you sure you want to approve this expense sheet?
                                            @*</div>*@

                                        </div>
                                        <div class="modal-footer ">

                                            <button id="btnApprove" type="button" onclick="ApproveButton();location.href= '@Url.Action("Approve", "Expense", new {id = Model.ExpenseId})'" name="submit" class="btn btn-success" ><span class="fa fa-check"></span> Yes</button>
                                            <button type="button" class="btn btn-danger" data-dismiss="modal"><span class="fa fa-close"></span> No</button>
                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>

                            <div class="modal fade" id="reject" tabindex="-1" role="dialog" aria-labelledby="reject" aria-hidden="true">
                                <div class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="close"><span class="fa fa-close" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading">Reject Expense Sheet</h4>
                                        </div>
                                        <div class="modal-body">

                                            <div class="alert">
                                                <span class="fa fa-exclamation-triangle"></span> Are you sure you want to reject this expense sheet? If Yes,  Please enter the reason for rejection.
                                            </div>


                                            <form id="rejectForm">
                                                <div class=" row">
                                                    <div class="form-group col-md-6">
                                                        @Html.HiddenFor(m => m.ExpenseId)
                                                        @Html.LabelFor(m => m.TempComments)
                                                        @Html.TextAreaFor(m => m.TempComments, new { @class = "form-control", @id = "comments", @rows ="5" })
                                                        <p class="text-danger" id="error"></p>
                                                        @*@Html.ValidationMessageFor(m => m.TempComments, "", new { @class = "text-danger" })*@
                                                    </div>
                                                </div>
                                            </form>

                                        </div>
                                        <div class="modal-footer ">
                                            <button  id="btnReject" type="button" class="btn btn-success" onclick="RejectButton();rejectComment();"><span class="fa fa-check"></span> Yes</button>
                                            <button type="button" class="btn btn-danger" data-dismiss="modal"><span class="fa fa-close"></span> No</button>

                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>
                            <div class="modal fade" id="deleteTS" tabindex="-1" role="dialog" aria-labelledby="deleteTS" aria-hidden="true">
                                <div class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" aria-label="close"><span class="fa fa-close" aria-hidden="true"></span></button>
                                            <h4 class="modal-title custom_align" id="Heading"> Delete Expense Sheet</h4>
                                        </div>
                                        <div class="modal-body">

                                            @*<div class="alert alert-warning">*@
                                            <span class="fa fa-exclamation-triangle"></span> Are you sure you want to delete this expense sheet?
                                            @*</div>*@

                                        </div>
                                        <div class="modal-footer ">
                                            <button type="button" onclick="location.href= '@Url.Action("SoftDeleteAdmin", "Expense" , new { id = Model.ExpenseId})'" name="submit" class="btn btn-success" id="btnSubmit"><span class="fa fa-check"></span> Yes</button>
                                            <button type="button" class="btn btn-danger" data-dismiss="modal"><span class="fa fa-close"></span> No</button>
                                        </div>
                                    </div>
                                    <!-- /.modal-content -->
                                </div>
                                <!-- /.modal-dialog -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
